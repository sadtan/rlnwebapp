<%- include('../../partials/header') -%>
<link rel="stylesheet" href="/stylesheets/admin.css">
<main>
    <div class="admin-cards">
        <h3>Creadores</h3>
        <table>
            <% 
            var creadores = data.data['creadores']; 
            var tipos = ['público', 'privado', 'mixto']
            for (var i = 0; i < creadores.length; ++i) { 
            %>
            <tr>
                <td style="padding: 0px 15px;">
                    <p><%=creadores[i]['id']%></ap>
                </td>
                <td>
                    <p><%=creadores[i]['nombre'].substring(0, 40)%></ap>
                </td>
                <td>
                    <form method="get" action="/admin/creadores/edit/<%=creadores[i]['id']%>">
                        <button style="color: blue; border-color: blue;" type="submit">editar</button> </form>
                <td>
                    <form method="post" action="/admin/creadores/delete/<%=creadores[i]['id']%>?_method=DELETE">
                        <button style="color: red; border-color: red;" type="submit">eliminar</button> </form>
                </td>
            </tr>
            <% 
            } 
            %>
        </table>
    </div>
    <div class="form-class">
        <form action="/admin/creadores/new" method="POST">
            <h3>Nuevo Creador</h3>
            <table>
                <tr>
                    <td><label for="pass">nombre</label></td>
                    <td><input type="text" name="obj[nombre]" class="text-input" required></td>
                </tr>
                <tr>
                    <td><label for="pass">imagen (s3 key)</label></td>
                    <td><input type="text" name="obj[imagen_path]" class="text-input"></td>
                </tr>
                <tr>
                    <td><label for="pass">descripción <br> imagen</label></td>
                    <td>
                        <input type="text" name="obj[imagen_descripcion]" class="text-input">
                    </td>
                </tr>
                <tr>
                    <td><label for="pass">tipo</label></td>
                    <td>
                        <select id="tipo" name="obj[tipo]">
                            <option value="0">público</option>
                            <option value="1">privado</option>
                            <option value="2">mixto</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <td><label for="pass">reseña</label></td>
                    <td><textarea name="obj[resena]" id="" cols="33" rows="5"></textarea></td>
                </tr>
                <tr>
                    <td><label for="pass">sociopolítico</label></td>
                    <td><textarea name="obj[sociopolitico]" id="" cols="33" rows="7"></textarea></td>
                </tr>
                <tr>
                    <td><label for="pass">caracterización</label></td>
                    <td><textarea name="obj[caracterizacion]" id="" cols="33" rows="7"></textarea></td>
                </tr>
                <tr>
                    <td><label for="pass">documentos</label></td>
                    <td>
                        <button id="myBtn" style="width: 100%;"> modificar documentos </button>
                        <input type="text" id="json-input"name="obj[documentos_json]" class="text-input">
                    </td>
                </tr>
                <tr>
                    <td><label for="pass">resp nombre</label></td>
                    <td>
                        <input type="text" name="obj[responsable_nombre]" class="text-input">
                    </td>
                </tr>
                <tr>
                    <td><label for="pass">resp celular</label></td>
                    <td>
                        <input type="text" name="obj[responsable_celular]" class="text-input">
                    </td>
                </tr>
                <tr>
                    <td><label for="pass">resp correo</label></td>
                    <td>
                        <input type="text" name="obj[responsable_correo]" class="text-input">
                    </td>
                </tr>
                <tr>
                    <td><label for="pass">ilustración 1 (s3 key)</label></td>
                    <td>
                        <input type="text" name="obj[il_1_path]" class="text-input">
                    </td>
                </tr>
                <tr>
                    <td><label for="pass">ilustración 2 (s3 key)</label></td>
                    <td>
                        <input type="text" name="obj[il_2_path]" class="text-input">
                    </td>
                </tr>
                <tr>
                    <td><label for="pass">imagen linea (s3 key)</label></td>
                    <td>
                        <input type="text" name="obj[img_linea_path]" class="text-input">
                    </td>
                </tr>
                <tr>
                    <td><label for="pass">imagen azul (s3 key)</label></td>
                    <td>
                        <input type="text" name="obj[img_azul_path]" class="text-input">
                    </td>
                </tr>

                <tr>
                    <td><label for="pass">lugar id</label><a href="/admin/lugares" target="_blank"> (Ver Lugares)</a></td>
                    <td><input type="number" name="obj[fk_lugar]" class="text-input" required></td>
                </tr>
            </table>
            <br>
            <button type="submit">Crear</button>
        </form>
    </div>

    <!-- The Modal -->
    <div id="myModal" class="modal">

        <!-- Modal content -->
        <div class="modal-content">
            <span class="close">&times;</span>

            <table id="myTable" style="width: 100%;">
            </table>
            <button id="myBtnAdd" style="margin-left: 20px;">+</button>
            <button id="myBtnAcc" style="margin-left: 20px;">Aceptar</button>
        </div>

    </div>

    <script>
        // Get the modal
        var modal = document.getElementById("myModal");



        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");
        var addBtn = document.getElementById("myBtnAdd");
        var accBtn = document.getElementById("myBtnAcc");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // Get the Json
        // Get Table
        var doc_table;
        var json_val;
        var json_obj;

        btn.addEventListener("click", function (event) {
            event.preventDefault();
            modal.style.display = "block";

            doc_table = document.getElementById("myTable");
            json_val = document.getElementById("json-input").value;
            doc_table.innerHTML = "";
            json_obj = JSON.parse(json_val.replace(/(\r\n|\n|\r|')/gm, '"'))['obj'];
            console.log(json_val);

            console.log(json_obj);
            for (doc in json_obj) {
                console.log(json_obj[doc]);
                var row = doc_table.insertRow(doc);
                var name = row.insertCell(0);
                var url = row.insertCell(1);
                var del = row.insertCell(2);

                name.innerHTML = '<input type="text" class="text-input" value="' + json_obj[doc]['name'] + '" id=n' + doc + '>';
                url.innerHTML  = '<input type="text" class="text-input" value="' + json_obj[doc]['url']  + '" id=u' + doc + '>';
                del.innerHTML = '<button onClick="deleteRow(' + doc + ')">&times</button>'
                console.log(doc);
            }
            updateEvents()
        });

        addBtn.addEventListener("click", function (event) {
            doc_table = document.getElementById("myTable");
            var row = doc_table.insertRow(-1);

            var name = row.insertCell(0);
            var url = row.insertCell(1);
            var del = row.insertCell(2);
            var lastRow = doc_table.rows.length - 1;
            name.innerHTML = '<input type="text" class="text-input" value="" id=n' + lastRow + ' >';
            url.innerHTML  = '<input type="text" class="text-input" value="" id=u' + lastRow + ' >';

            del.innerHTML = '<button onClick="deleteRow(' + lastRow + ')">&times</button>'
            updateEvents()
        });

        accBtn.addEventListener("click", function (event) {
            var final_obj = { obj: [] };
            for (let i = 0; i < doc_table.rows.length; ++i) {
                final_obj['obj'].push({});
                var name = doc_table.rows[i].cells[0].innerHTML;
                var url = doc_table.rows[i].cells[1].innerHTML;
                final_obj['obj'][i]['name'] = name.substring(45, name.length - 10);
                final_obj['obj'][i]['url'] = url.substring(45, url.length - 10);
                console.log( url.substring(45, url.length - 10));
            }
            updateEvents();
            document.getElementById("json-input").value = "";
            document.getElementById("json-input").value = JSON.stringify(final_obj).replace(/(\r\n|\n|\r|")/gm, "'");
            console.log(JSON.stringify(final_obj).replace(/(\r\n|\n|\r|")/gm, "'"));
            modal.style.display = "none";
        });

        function deleteRow(r) {
            doc_table.deleteRow(r);
            for (let i = 0; i < doc_table.rows.length; ++i) {
                doc_table.rows[i].cells[2].innerHTML = '<button onClick="deleteRow(' + i + ')">&times</button>';
            }
            for (let i = 0; i < doc_table.rows.length; ++i) 
            {
                doc_table.rows[i].cells[0].innerHTML = doc_table.rows[i].cells[0].innerHTML.substring(0, doc_table.rows[i].cells[0].innerHTML.length - 3) + i + '">';
                doc_table.rows[i].cells[1].innerHTML = doc_table.rows[i].cells[1].innerHTML.substring(0, doc_table.rows[i].cells[1].innerHTML.length - 3) + i + '">';
            }
            
        }

        function updateEvents() {
            doc_table = document.getElementById("myTable");

            for (let i = 0; i < doc_table.rows.length; ++i) 
            {
                if (document.getElementById("n" + i)) 
                {
                    var name = document.getElementById("n" + i);
                    var url = document.getElementById("u" + i);
                    
                    //name.setAttribute("value", name.value)
                    name.addEventListener('change', function(){
                        name.setAttribute("value", name.value)
                    });
                    url.addEventListener('change', function(){
                        url.setAttribute("value", url.value)
                    });
                    
                }
                
            }
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function () {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    </script>


</main>